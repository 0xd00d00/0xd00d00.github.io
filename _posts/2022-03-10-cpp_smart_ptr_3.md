---
layout: post
author: doodoo
title: "[C++][Modern C++] shared_ptr μ¤λ§νΈν¬μΈν„° (ii)"
subtitle: "shared_ptrμ—μ„ λ°μƒν•  μ μλ” λ¬Έμ μ  λ° ν•΄κ²°μ±…μ— λ€ν•΄ μ•μ•„λ³΄μ π¤“"
date: 2022-03-10
cover: /assets/img/default.png
tags: C++ Modern C++
sitemap :
 changefreq : daily
 priority : 1.0
---
μ•λ…•ν•μ„Έμ”! <span class="doodoo">λ‘λ‘μ½”λ”©</span> μ…λ‹λ‹¤ β‹ <br>
μ¤λμ€ Shared ptrμ—μ„ λ°μƒν•  μ μλ” λ¬Έμ μ™€ ν•΄κ²°μ±…μ— λ€ν•΄ μ•μ•„λ³΄κ² μµλ‹λ‹¤.

π–‡ μ†μ¤μ½”λ“μ— λ§μ°μ¤λ¥Ό μ¬λ¦¬κ³  <span class="tip">copy</span> λ²„νΌμ„ λ„λ¥Ό κ²½μ° λ” μ‰½κ² λ³µμ‚¬ν•  μ μμµλ‹λ‹¤! 

κ¶κΈν• μ , λ³΄μ•μ  λ‚¨κ²¨μ£Όμ‹λ©΄ μ„±μ‹¤ν λ‹µλ³€ν•κ² μµλ‹λ‹¤. π <br>
\+ κ°μƒν‰ λ“κΈ€λ΅ λ‚¨κ²¨μ£Όμ‹λ©΄ νμ΄λ©λ‹λ‹¤. π™‡

### Shared ptrμ—μ„ λ°μƒν•  μ μλ” λ¬Έμ μ 
`shared_ptr`μ„ μ‚¬μ©ν•λ©΄ λ©”λ¨λ¦¬ ν• λ‹Ήμ΄ λ‡ λ² μΌμ–΄λ‚ κΉ? *λ€μƒκ°μ²΄ ν• λ‹Ή* λ°
*Control block ν• λ‹Ή* μ΄ 2λ² λ°μƒν•κ² λλ‹¤.

ν• λ‹Ήκ³Όμ •μ—μ„ 2κ°€μ§€ λ¬Έμ μ μ΄ λ°μƒν•κ² λλ‹¤.

*π± memory fragmentation*

μ•„λμ κ·Έλ¦Όμ„ λ³΄μ. μ°λ¦¬κ°€ `shared_ptr`μ„ ν†µν•΄ κ°μ²΄λ¥Ό μƒμ„±ν•  κ²½μ°μ κ·Έλ¦Όμ΄λ‹¤.

![sptr3](/assets/img/sptr3.png)

μ„μ κ·Έλ¦Όκ³Ό κ°™μ΄, 2κ°μ κ°μ²΄λ¥Ό μƒμ„±ν•κΈ° λ•λ¬Έμ— "λ©”λ¨λ¦¬ λ‹¨νΈν™”" λ¬Έμ κ°€ λ°μƒν•λ‹¤.
μ¦‰, λ©”λ¨λ¦¬λ” μ΅΄μ¬ν•λ”λ° λ‹¨νΈμ μΌλ΅ μ΅΄μ¬ν•΄ μ—°μ†μ μΈ λ©”λ¨λ¦¬λ¥Ό μ κ³µν•μ§€ λ»ν•λ”
λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤.


*π± μ»΄νμΌμ‹ μ—λ¬ μ‹, μμ›λ„μ*

μ»΄νμΌλ¬ λ³„λ΅ μ½”λ“λ¥Ό μ»΄νμΌ μμ„κ°€ κ°™μ€μλ„ μκ³  λ‹¤λ¥Όμλ„ μλ‹¤. μ»΄νμΌλ¬λ΅ μΈν•΄
`shared_ptr` κ°μ²΄μ—μ„λ” "μμ› λ„μ"λ¬Έμ κ°€ λ°μƒν•  μ μλ‹¤.

![sptr4](/assets/img/sptr4.png)

μ„μ κ·Έλ¦Όκ³Ό κ°™μ΄, `shared_ptr`λ¥Ό ν†µν•΄ κ°μ²΄λ¥Ό ν¬μΈν…ν•κ³  μ μ–΄κ°μ²΄λ¥Ό μƒμ„±ν•λ”
κ³Όμ •μ„ λ³΄μ.

1. κ°μ²΄ ν• λ‹Ή
2. κ°μ²΄ ν¬μΈν…
3. Control block ν• λ‹Ή
4. Control block ν¬μΈν…

4κ°€μ§€ κ³Όμ •μΌλ΅ λ³Ό μ μλ”λ°, κ°μ²΄ ν¬μΈν… μ΄ν›„ "Control block"μ„ ν• λ‹Ήν•λ” κ³Όμ •μ—μ„
μ»΄νμΌ μ—λ¬κ°€ λ°μƒν•  κ²½μ° ν•΄λ‹Ή κ°μ²΄λ¥Ό μ κ±°ν•  μ μλ‹¤.

ν•μ§€λ§, μ»΄νμΌλ¬ λ³„λ΅ ν• λ‹Ήν•  μ μλ” κ°μ²΄λ¥Ό λ¨Όμ € ν• λ‹Ήν•κ³ , μ΄ν›„μ— ν¬μΈν…ν•λ”
μ»΄νμΌλ¬κ°€ μλ”λ° μ΄ κ²½μ° *μμ›λ„μ*κ°€ λ°μƒν•κ² λλ‹¤.

μ¦‰, λ€μƒκ°μ²΄λ¥Ό λ¨Όμ €ν• λ‹Ήν•κ³ , μ»¨νΈλ΅¤ λΈ”λ΅¤ κ°μ²΄λ¥Ό ν• λ‹Ήν•λ” κ³Όμ •μ—μ„ *μ—λ¬κ°€ λ°μƒ*
ν–λ‹¤κ³  κ°€μ •ν•΄λ³΄μ. μ΄ κ²½μ° μ²μμ— ν• λ‹Ήν–λ λ€μƒκ°μ²΄λ” κ°€λ¦¬ν‚¤κ³  μλ” ν¬μΈν„°κ°€
μ—†κΈ° λ•λ¬Έμ— μ‹μ¤ν… μΆ…λ£μ‹ κΉμ§€ μ κ±°κ°€ λ¶κ°€λ¥ν•λ‹¤. μ΄λ° κ²½μ°λ¥Ό μ°λ¦¬λ” *μμ›λ„μ*κ°€ λ°μƒν–λ‹¤κ³  ν•λ‹¤.

μ„ λ‘κ°€μ§€λ¥Ό λ§‰κΈ° μ„ν•΄, C++μ—μ„λ” `make_shared` ν•¨μλ¥Ό μ κ±°ν•λ‹¤

### ν•΄κ²°μ‚¬: make_shared
`make_shared` ν•¨μλ¥Ό ν™μ©ν•λ©΄ μ•„λμ κ·Έλ¦Όκ³Ό κ°™μ΄ λ€μƒκ°μ²΄μ™€ Control blockμ„
μ—°μ†μ μΈ λ©”λ¨λ¦¬ κ³µκ°„μ— κ°™μ΄ μƒμ„±ν•λ„λ΅ ν•λ‹¤.

![sptr5](/assets/img/sptr5.png)

μ„μ™€ κ°™μ΄ `make_shared`λ¥Ό μ‚¬μ©ν•  κ²½μ° λ€μƒκ°μ²΄μ™€ Control blockμ„ κ°™μ΄ μƒμ„±ν•κΈ°
λ•λ¬Έμ— λ©”λ¨λ¦¬ ν¨μ¨μ μ΄λ©°, μμ™Έμ—λ„ μ•μ „ν•κ² μμ›μ„ μ κ±°ν•  μ μλ‹¤.

`make_shared`μ μ‚¬μ©λ²•μ€ μ•„λμ™€ κ°™λ‹¤.

```cpp
int main() {
	// μ™ λ§ν•΄μ„λ” make_sharedλ΅ shared ptrλ¥Ό μƒμ„±ν•λ„λ΅ ν•μ!!
	// 2κ°€μ§€ λ‹¤ μ‚¬μ©κ°€λ¥
	shared_ptr<Car> p = make_shared<Car>();
	shared_ptr<Car> p1(make_shared<Car>());
}
```
