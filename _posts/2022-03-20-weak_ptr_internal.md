---
layout: post
author: doodoo
title: "[C++][Modern C++] weak_ptr ë‚´ë¶€ êµ¬ì¡°"
subtitle: "weak pointerì˜ ë‚´ë¶€êµ¬ì¡°ë¥¼ ì•Œì•„ë³´ì ğŸ™„"
date: 2022-03-20
cover: /assets/img/default.png
tags: C++ Modern_C++
sitemap :
 changefreq : daily
 priority : 1.0
---
ì•ˆë…•í•˜ì„¸ìš”! <span class="doodoo">ë‘ë‘ì½”ë”©</span> ì…ë‹ˆë‹¤ âœ‹ <br>
ì˜¤ëŠ˜ì€ weak pointer ë‚´ë¶€êµ¬ì¡°ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

ğŸ–‡ ì†ŒìŠ¤ì½”ë“œì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ê³  <span class="tip">copy</span> ë²„íŠ¼ì„ ëˆ„ë¥¼ ê²½ìš° ë” ì‰½ê²Œ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

ê¶ê¸ˆí•œ ì , ë³´ì•ˆì  ë‚¨ê²¨ì£¼ì‹œë©´ ì„±ì‹¤íˆ ë‹µë³€í•˜ê² ìŠµë‹ˆë‹¤. ğŸ˜ <br>
\+ ê°ìƒí‰ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì‹œë©´ í˜ì´ë©ë‹ˆë‹¤. ğŸ™‡

### Intro.
ì´ì „ í¬ìŠ¤íŒ…ë¶€í„° í•¨ê»˜ ì‚¬ìš©í•´ ì˜¨ `car.h` í—¤ë”íŒŒì¼ì„ ê³µìœ í•œë‹¤. ì´ header fileì˜ ê·¼ì›ì„ ë³´ê³  ì‹¶ë‹¤ë©´, [ì—¬ê¸°](https://0xd00d00.github.io/2022/03/09/cpp_smart_ptr_2.html)ë¥¼ í´ë¦­í•´ì„œ ì•Œì•„ë³´ì.

```cpp
// car.h
#include <iostream>

class Car {
  int color;
  int speed;

public:
  Car(int c = 0, int s = 0) : color(c), speed(s) {}

  // ì–¸ì œ íŒŒê´´ë˜ëŠ”ì§€ ì•Œì•„ë³´ëŠ” ë¡œê·¸ìš©
  ~Car() { std::cout << "~Car()" << std::endl; }

  void Go() { std::cout << "Car go!" << std::endl; }
};
```

ì•„ë˜ì½”ë“œì—ì„œëŠ” í•´ë‹¹ íŒŒì¼ì„ header file `car.h`ë¡œ ì¶”ê°€í•´ ì‚¬ìš©í•˜ê³ ì í•œë‹¤.

### weak_ptr ë™ì‘ì›ë¦¬
`weak_ptr`ë¥¼ í™œìš©í•˜ë©´, ëŒ€ìƒ ê°ì²´ê°€ íŒŒê´´ë˜ì—ˆëŠ”ì§€ë¥¼ ì•Œ ìˆ˜ ìˆëŠ” `expired()`ë¥¼
ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ê°€ ê°€ë¦¬í‚¤ëŠ” ëŒ€ìƒ ê°ì²´ê°€ íŒŒê´´ë˜ì—ˆëŠ”ë°, ì–´ë–»ê²Œ ìŠ¤ë§ˆíŠ¸
í¬ì¸í„°ë¡œ ëŒ€ìƒ ê°ì²´ì— ëŒ€í•œ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ìˆì„ê¹Œ?

ë¹„ë°€ì€ ë°”ë¡œ *Control block* ì— ì¡´ì¬í•œë‹¤.

ì•„ë˜ì˜ ì½”ë“œë¥¼ í†µí•´ ì´ì•¼ê¸°í•´ë³´ì.

```cpp
#include <iostream>
#include <memory>
#include "car.h"

using namespace std;

int main() {
	weak_ptr<Car> wp;
	{
		shared_ptr<Car> sp = make_shared<Car>();

		cout << sp.use_count() << endl;
		wp = sp;
	}

	if (wp.expired())
		cout << "ëŒ€ìƒ ê°ì²´ëŠ” íŒŒê´´ë¨..";

}
```

ìœ„ì˜ ì½”ë“œ ì²˜ëŸ¼, `{ ... }` ë‚´ë¶€ë¥¼ ë²—ì–´ë‚˜ê²Œ ë˜ë©´ `shared_ptr`ì´ ê°€ë¦¬í‚¤ê³  ìˆëŠ” ëŒ€ìƒ
ê°ì²´ëŠ” íŒŒê´´ ëœë‹¤. `weak_ptr` ë˜í•œ ëŒ€ìƒê°ì²´ê°€ íŒŒê´´ë˜ëŠ”ë° ì–´ë–»ê²Œ ëŒ€ìƒ
ê°ì²´ì— ëŒ€í•œ ì •ë³´ë¥¼ ê³„ì†í•´ì„œ ìœ ì§€í•  ìˆ˜ ìˆëŠ”ì§€ì— ëŒ€í•´ ì•Œì•„ë³´ì.

ì•„ë˜ì˜ ê·¸ë¨ì„ ë³´ì.

![sptr10](/assets/img/sptr10.png)

`Shared_ptr`ë¥¼ ë§Œë“¤ê²Œ ë˜ë©´ ëŒ€ìƒê°ì²´ì™€ Control blockì„ ë§Œë“œëŠ” ê²ƒì„ ì£¼êµ¬ì¥ì°½ [ì´ì „
í¬ìŠ¤íŒ…](https://0xd00d00.github.io/2022/03/09/cpp_smart_ptr_2.html)ì„ í†µí•´ì„œ ë“¤ì–´ì™”ì„ ê²ƒì´ë‹¤.

Scopeë¥¼ ë²—ì–´ë‚˜ë©´ `shared_ptr`ì€ ëŒ€ìƒê°ì²´ë¥¼ íŒŒê´´í•œë‹¤. ë˜í•œ Control blockì„
íŒŒê´´í•˜ëŠ”ë°, íŒŒê´´ë˜ëŠ” ì¡°ê±´ì´ *use_count* ê°€ "0" ì¸ì§€ í™•ì¸í•œë‹¤. ë˜í•œ *weak count*
ë¼ëŠ” weak_ptrì˜ reference ì •ë³´ë„ "0" ì¸ì§€ë¥¼ ê°™ì´ í™•ì¸í•œë‹¤.

ë§Œì•½ `weak_ptr`ì´ ê°€ë¦¬í‚¤ê³  ìˆì–´ weak countê°€ "0"ì´ ì•„ë‹ˆë©´ *Control block* ì€
íŒŒê´´í•˜ì§€ ì•Šê³  ìœ ì§€í•œë‹¤. ì´í›„ `expired()`ë¥¼ í†µí•´ ë‚´ë¶€ pointerë¥¼ í™œìš©í•´ nullì¸ì§€ë¥¼
íŒë‹¨í•˜ê³ , bool ê°’ìœ¼ë¡œ ë°˜í™˜í•´ì¤€ë‹¤.

ê·¸ë¦¼ì—ì„œ ë³´ì´ëŠ” Control blockì˜ ì •ë³´ ì¤‘ weak counterì™€ ptrì€ ì´ëŸ´ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´
ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë¼ëŠ” ê²ƒì„ ê¸°ì–µí•  í•„ìš”ê°€ ìˆë‹¤.

### Reference
[C++ ê°•ì˜](http://www.ecourse.co.kr)
