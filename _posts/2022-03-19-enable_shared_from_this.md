---
layout: post
author: doodoo
title: "[C++][Modern C++] enable_shared_from_this ë€?"
subtitle: "Shared pointerë¥¼ ì‚¬ìš©í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë¥¼ ì•Œì•„ë³´ì ğŸ˜·"
date: 2022-03-19
cover: /assets/img/default.png
tags: C++ Modern_C++
sitemap :
 changefreq : daily
 priority : 1.0
---
ì•ˆë…•í•˜ì„¸ìš”! <span class="doodoo">ë‘ë‘ì½”ë”©</span> ì…ë‹ˆë‹¤ âœ‹ <br>
ì˜¤ëŠ˜ì€ enable_shared_from_this ì‚¬ìš©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

ğŸ–‡ ì†ŒìŠ¤ì½”ë“œì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ê³  <span class="tip">copy</span> ë²„íŠ¼ì„ ëˆ„ë¥¼ ê²½ìš° ë” ì‰½ê²Œ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

ê¶ê¸ˆí•œ ì , ë³´ì•ˆì  ë‚¨ê²¨ì£¼ì‹œë©´ ì„±ì‹¤íˆ ë‹µë³€í•˜ê² ìŠµë‹ˆë‹¤. ğŸ˜ <br>
\+ ê°ìƒí‰ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì‹œë©´ í˜ì´ë©ë‹ˆë‹¤. ğŸ™‡

### Intro.
ì´ì „ í¬ìŠ¤íŒ…ë¶€í„° í•¨ê»˜ ì‚¬ìš©í•´ ì˜¨ `car.h` í—¤ë”íŒŒì¼ì„ ê³µìœ í•œë‹¤. ì´ header fileì˜ ê·¼ì›ì„ ë³´ê³  ì‹¶ë‹¤ë©´, [ì—¬ê¸°](https://0xd00d00.github.io/2022/03/09/cpp_smart_ptr_2.html)ë¥¼ í´ë¦­í•´ì„œ ì•Œì•„ë³´ì.

```cpp
// car.h
#include <iostream>

class Car {
  int color;
  int speed;

public:
  Car(int c = 0, int s = 0) : color(c), speed(s) {}

  // ì–¸ì œ íŒŒê´´ë˜ëŠ”ì§€ ì•Œì•„ë³´ëŠ” ë¡œê·¸ìš©
  ~Car() { std::cout << "~Car()" << std::endl; }

  void Go() { std::cout << "Car go!" << std::endl; }
};
```

ìœ„ `car.h`íŒŒì¼ì„ ì¸í´ë£¨ë”©í•´ì„œ ì‚¬ìš©í•˜ê³ ì í•œë‹¤. í•´ë‹¹ ì½”ë“œëŠ” ìƒì„±ì, ì†Œë©¸ì, `Go()` ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê³  ìˆëŠ” ë‹¨ìˆœí•œ Car classì´ë‹¤.

### Shared_ptrë¡œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œ
[ì´ì „ í¬ìŠ¤íŒ…](https://0xd00d00.github.io/2022/03/10/cpp_smart_ptr_3.html)ì„ í†µí•´ `shared_ptr` ê°™ì€ ê²½ìš° RAII ì›ì¹™ì„ ì§€ì¼œ ì´ˆê¸°í™” í•´ì•¼ë˜ëŠ” ê²ƒì„ ì•Œê²Œë˜ì—ˆë‹¤.

ë§Œì•½ ì´ ì›ì¹™ì„ ì§€í‚¤ì§€ ì•Šê³ , Raw pointerë¥¼ í™œìš©í•˜ì—¬ ì´ˆê¸°í™”í•˜ê²Œ ë  ê²½ìš° ì–´ë–¤
ë¬¸ì œê°€ ë°œìƒí•˜ëŠ”ì§€ ì•Œì•„ë³´ì. multi-theadì—ì„œ ë¬¸ì œë¥¼ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë° í•´ë‹¹
ì¼€ì´ìŠ¤ë¥¼ ë³´ë„ë¡ í•˜ì.

```cpp
#include <iostream>
#include <memory>
#include <thread>
#include "Car.h"

using namespace std;

class Worker {
	Car c;

public:
	void Run()
	{
		thread t(&Worker::Main, this);
		t.detach();
	}

	void Main() {
		c.Go();	// ë©¤ë²„ data(Car) ì‚¬ìš©
		cout << "finish thread" << endl;
	}
};

int main()
{
	shared_ptr<Worker> sp = make_shared<Worker>();
	sp->Run();
	getchar();
}
```

ìœ„ì˜ ì½”ë“œë¥¼ ë³´ë©´, ë¬¸ì œ ì—†ì´ ì˜ ë™ì‘í•˜ëŠ” ì½”ë“œë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤. Workerì˜ `Run()`ë¥¼
í˜¸ì¶œí•˜ê²Œ ë˜ë©´, ë‚´ë¶€ì ìœ¼ë¡œ threadë¥¼ ìƒì„±í•´, Main ë¬¸ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ì´ë‹¤.

ë§Œì•½ ì•„ë˜ì™€ ê°™ì´, shared_ptrì˜ ìˆ˜ëª… scopeê°€ ë‹¬ë¼ì§€ê²Œ ëœë‹¤ë©´ ì–´ë–»ê²Œ ë ê¹Œ?

```cpp
int main()
{
	{
		shared_ptr<Worker> sp = make_shared<Worker>();
		sp->Run();
	}
	getchar();
}
```

ìœ„ì™€ ê°™ì´ ì‘ì„±í•  ê²½ìš° ì•„ë˜ ê·¸ë¦¼ê³¼ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

![sptr8](/assets/img/sptr8.png)

`Worker` ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , ë‚´ë¶€ì ìœ¼ë¡œ threadë¥¼ ìƒì„±í•´ Mainì„ ìˆ˜í–‰í•˜ëŠ” ë„ì¤‘
scopeë¥¼ ë²—ì–´ë‚˜ê²Œ ëœë‹¤. ê·¸ëŸ´ ê²½ìš° `Worker`ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ê³  ìˆëŠ” `shared_ptr`ì˜ íŒŒê´´ë¡œ ëŒ€ìƒ ê°ì²´ê°€
íŒŒê´´ë˜ê³ , ë‚´ë¶€ì ì¸ `Car` ê°ì²´ë„ íŒŒê´´ë˜ê²Œëœë‹¤. threadëŠ” `Car` ê°ì²´ë¥¼ í™œìš©í•´
ì‘ì—…ì„ í•˜ê³  ìˆëŠ”ë°, *ëŒ€ìƒê°ì²´ê°€ ë¨¼ì € íŒŒê´´ë˜ëŠ” ì¼ì´ ë°œìƒí•œë‹¤*

ì¦‰, `Worker` ê°ì²´ì˜ ìˆ˜ëª…ìœ¼ë¡œ ì¸í•´ ë°œìƒë˜ëŠ” ë¬¸ì œë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤.

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ”, `sp1`ì´ ì‚¬ìš©ìœ ë¬´ì™€ ê´€ê³„ì—†ì´ thread ê°€ ì¢…ë£Œë˜ë©´
`sp1`ì„ íŒŒê´´í•˜ë„ë¡ í•´ì•¼í•œë‹¤. ì´ ë°©ë²•ìœ¼ë¡œ ì§„í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” thread ìƒì„± ì‹œ,
*ì°¸ì¡°ê³„ìˆ˜*ë¥¼ *+1* ì¦ê°€ì‹œì¼œì•¼í•œë‹¤.

#### Raw pointerë¥¼ ì¶”ê°€í•˜ëŠ” ì¼€ì´ìŠ¤

*ì°¸ì¡°ê³„ìˆ˜*ë¥¼ ì¦ê°€ì‹œí‚¤ê¸° ìœ„í•´ `Worker` í´ë˜ìŠ¤ë‚´ `shared_ptr` í¬ì¸í„°ë¥¼ í•˜ë‚˜
ë‘¬ì•¼í•œë‹¤. ë§Œì•½ ì•„ë˜ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•˜ê²Œ ëœë‹¤ë©´ ì˜ ë™ì‘í• ê¹Œ?

```cpp
class Worker {
	Car c;
	// ì°¸ì¡°ê³„ìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¤ê¸° ìœ„í•œ
	// shared_ptr ì¶”ê°€!!
	shared_ptr<Worker> holdMe;

public:
	void Run()
	{
		// Raw pointerë¥¼ ì¶”ê°€.. //
		holdeMe = this;
		thread t(&Worker::Main, this);
		t.detach();
	}

	void Main() {
		c.Go();	// ë©¤ë²„ data(Car) ì‚¬ìš©
		cout << "finish thread" << endl;
	}
};
```

ìœ„ì™€ ê°™ì´ `holdMe`ë¼ëŠ” í¬ì¸í„°ë¥¼ ë§Œë“¤ì–´ ì°¸ì¡° ê³„ìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¤ê³ ì í•œë‹¤. `Worker`
ë³¸ì¸ì„ ê°€ë¦¬í‚¤ë©´ ë˜ì§€ ì•Šì„ê¹Œ í•´ì„œ `this`ë¡œ ì´ˆê¸°í™”í•˜ê²Œ ë  ê²½ìš° raw pointerë¡œ
`shared_ptr`ë¥¼ ì´ˆê¸°í™” í•˜ê²Œ ëœë‹¤. ì´ëŸ´ ê²½ìš° [ì´ì „ í¬ìŠ¤íŒ…](https://0xd00d00.github.io/2022/03/10/cpp_smart_ptr_3.html) ì—ì„œ ë§Œë‚¬ë˜ ë¬¸ì œ, ì œì–´ë¸”ë¡ì´ 2ê°œ ìƒê¸°ê³  *ì°¸ì¡°ê³„ìˆ˜*ëŠ” ì¦ê°€í•˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ì™¸ë¶€ì—ì„œ `shared_ptr`ë¥¼ ì „ë‹¬ë°›ì•„ì•¼í•œë‹¤.

#### shared_ptrë¥¼ ì „ë‹¬ë°›ì•„ ì´ˆê¸°í™”
`shared_ptr`ë¥¼ ì™¸ë¶€ì—ì„œ ì „ë‹¬ë°›ì•„ ì´ˆê¸°í™”í•  ê²½ìš° *ì°¸ì¡°ê³„ìˆ˜*ë¥¼ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

```cpp
class Worker {
	Car c;
	// ì°¸ì¡°ê³„ìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¤ê¸° ìœ„í•œ
	// shared_ptr ì¶”ê°€!!
	shared_ptr<Worker> holdMe;

public:
	void Run(shared_ptr<Worker> p)
	{
		// Raw pointerë¥¼ ì¶”ê°€.. //
		holdeMe = p;
		thread t(&Worker::Main, this);
		t.detach();
	}

	void Main() {
		c.Go();	// ë©¤ë²„ data(Car) ì‚¬ìš©
		cout << "finish thread" << endl;
	}
};
```

ìœ„ì™€ ê°™ì´ `Worker` í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•˜ê³ , ì™¸ë¶€ì—ì„œ `shared_ptr`ë¥¼ ì „ë‹¬í•´
ì°¸ì¡°ê³„ìˆ˜ë¥¼ í•˜ë‚˜ ì¦ê°€ì‹œí‚¤ëŠ” ë°©ì‹ìœ¼ë¡œ ì§„í–‰í•œë‹¤. ê·¸ë ‡ë‹¤ë©´ ì™¸ë¶€ì—ì„œëŠ” ì–´ë–»ê²Œ
ì „ë‹¬í•´ì•¼ë ê¹Œ?

```cpp
int main()
{
	{
		shared_ptr<Worker> sp = make_shared<Worker>();
		// ì¸ìë¡œ sp ì „ë‹¬..
		// ëª¨ì–‘ì´ ì•ˆì´ì¨..
		sp->Run(sp);
	}
	getchar();
}
```

ìœ„ì™€ ê°™ì´ `sp->Run(sp)`ì™€ ê°™ì´, ë¶€ë¥´ê²Œ ë˜ëŠ”ë° ì´ë ‡ê²Œ ë¶€ë¥¼ ê²½ìš° *ì½”ë“œì˜ ê°€ë…ì„±*ì´
ë–¨ì–´ì§€ê²Œ ëœë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë“±ì¥í•œ ê°œë…ì´ ë°”ë¡œ
`enable_shared_from_this`ì´ë‹¤.

### enable_shared_from_this ì˜ ì‚¬ìš©
ì‚¬ìš©ë°©ë²•ì€ `enable_shared_from_this` í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ì•„ ì‚¬ìš©í•˜ë©°, Template ì¸ìë¡œ ë³¸ì¸ì˜
ì´ë¦„ì„ ì „ë‹¬í•˜ë©´ ëœë‹¤. ì´ëŸ° ë°©ë²•ì„ ìš°ë¦¬ëŠ” *CRTP*ë¼ê³  ë¶€ë¥¸ë‹¤.

ì•„ë˜ì˜ ì½”ë“œë¥¼ í†µí•´ ì‚¬ìš©ë°©ë²•ì„ ë³´ì.

```cpp
class Worker : public enable_shared_from_this<Worker> // CRTP
{
	Car c;
	shared_ptr<Worker> holdMe;

public:
	void Run(shared_ptr<Worker> p)
	{
		// í˜„ì¬ ê°ì²´ì˜ ì œì–´ë¸”ë¡ì„ ê³µìœ í•´ì¤˜~
		holdeMe = shared_from_this();
		thread t(&Worker::Main, this);
		t.detach();
	}

	void Main() {
		c.Go();	// ë©¤ë²„ data(Car) ì‚¬ìš©
		cout << "finish thread" << endl;
	}
};
```

`enable_shared_from_this`ë¥¼ ì‚¬ìš©í•˜ë©´, `this`ê°ì²´ë¥¼ í™œìš©í•´ `shared_ptr`ì˜
ì œì–´ë¸”ë¡ì„ ê³µìœ í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤. ì œì–´ë¸”ë¡ì„ ê³µìœ í•˜ê¸° ìœ„í•´ì„œëŠ”
`shared_from_this()`ë¼ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ëœë‹¤.

ì—¬ê¸°ì„œ ì£¼ì˜í•  ì ì´ 2ê°€ì§€ ìˆë‹¤.

1. `shared_from_this()` í˜¸ì¶œí•˜ê¸° ì „ì— ë°˜ë“œì‹œ `shared_ptr`ê°ì²´ê°€ ë§Œë“¤ì–´ ì¦‰,
   ì œì–´ë¸”ëŸ­ì´ ë§Œë“¤ì–´ì ¸ ìˆì–´ì•¼í•œë‹¤. ë§Œì•½ ì•ˆë§Œë“¤ì–´ì ¸ìˆì„ ê²½ìš° `undefined`ë¡œ ë¯¸ì •ì˜
   ë™ì‘ì„ ìˆ˜í–‰í•œë‹¤. (ê°€ì¥ ìœ„í—˜í•¨... ğŸ˜‘)

2. `shared_from_this()`ë¥¼ ì‚¬ìš©í•  ê²½ìš° ì§ì ‘ `reset()`ì„ í˜¸ì¶œí•´ì¤˜ì•¼í•œë‹¤.

```cpp
class Worker : public enable_shared_from_this<Worker>
{
	...

	void Main() {
		c.Go();
		cout << "finish thread" << endl;

		// ì°¸ì¡°ê³„ìˆ˜ ê°ì†Œ í•„ìš”!!
		HoldMe.reset();
	}

	...
};
```

ìœ„ì™€ê°™ì´, ì¡°ê±´ì— ë§ì¶°ì„œ ì°¸ì¡°ê³„ìˆ˜ë¥¼ ë‚´ë ¤ì¤„ ìˆ˜ ìˆëŠ” `reset()`ì„ í˜¸ì¶œí•´ì•¼ëœë‹¤.
ì§€ê¸ˆê°™ì€ ì¼€ì´ìŠ¤ëŠ” threadë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ê³  `reset()`ì„ í•˜ì§€ë§Œ, ê²½ìš°ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜
ìˆìœ¼ë‹ˆ *ì£¼ì˜í•´ì„œ ì‚¬ìš©*í•˜ë„ë¡ í•˜ì.


